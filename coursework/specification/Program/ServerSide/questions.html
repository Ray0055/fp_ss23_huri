<!DOCTYPE html>
<html>

<head>
    <title>Questions</title>
    <style>
        .pagination {
            display: inline-block;
        }

        .pagination a {
            margin: 4px;
            padding: 8px 16px;
            text-decoration: none;
            border: 1px solid #ddd;
        }

        .pagination a.active {
            background-color: #4CAF50;
            color: white;
            border: 1px solid #4CAF50;
        }

        .pagination a:hover:not(.active) {
            background-color: #ddd;
        }
    </style>
</head>

<body>

    <h1>Questions</h1>

    <table border="1">
        <tr>
            <th>ID</th>
            <th>Question</th>
            <th>Options</th>
            <th>CorrectIndex</th>
            <th>CreatedTime</th>
            <th>ModifiedTime</th>
            <th>Completed</th>

        </tr>
        {{range .}}
        <tr>
            <td>{{.ID}}</td>
            <td>{{.Question}}</td>
            <td>{{.Options}}</td>
            <td>{{.CorrectIndex}}</td>
            <td>{{.CreatedTime}}</td>
            <td>{{.ModifiedTime}}</td>
            <th>{{.Completed}}</th>
            <td><button data-id="{{.ID}}" onclick="deleteQuestion(this)">Delete</button></td>
            <td><button class="updateQuestion">Update</button></td>
        </tr>
        {{end}}

        <form id="addQuestionsForm">
            <input type="text" id="newQuestion" placeholder="New Question" />
            <input type="text" id="newOptions" placeholder="New Options" />
            <input type="number" id="newCorrectIndex" placeholder="New Correct Index" />
            <button type="submit" id="addQuestionsFormButton">Add Question</button>
        </form>
    </table>

    <div class="pagination">
        <a href="/api/questions?page=1">First</a>
        <a href="#" id="prev">Previous</a>
        <a href="#" id="next">Next</a>
        <a href="/api/questions?page=last" id="last">Last</a> <!-- 此处假设'last'为最后一页的页码，应由后端提供 -->
    </div>

    <script> // prev next button
        // 这里是简单的JavaScript代码，用于更新“Previous”和“Next”的链接。
        // 在一个完整的应用中，你可能会使用更复杂的前端代码来处理这些逻辑。
        var urlParams = new URLSearchParams(window.location.search);
        var page = urlParams.get('page');
        if (page) {
            var prevPage = parseInt(page) - 1;
            var nextPage = parseInt(page) + 1;
            document.getElementById('prev').setAttribute('href', '/api/questions?page=' + prevPage);
            document.getElementById('next').setAttribute('href', '/api/questions?page=' + nextPage);
        }
    </script>

    <script> //deleteQuestion
        function deleteQuestion(element) {
            const id = parseInt(element.getAttribute('data-id'),10) 
            console.log("Attempting to delete question %d", id)
            fetch(`/api/delete_question?id=${id}`, {
                method: 'DELETE',
            }).then(response => response.json())
                .then(data => {
                    location.reload();
                });
        }
    </script>

    <script> //add question
        document.getElementById('addQuestionsForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const newID = 1;
            const newQuestion = document.getElementById('newQuestion').value;
            const newOptions = document.getElementById('newOptions').value;
            const newCorrectIndex = parseInt(document.getElementById('newCorrectIndex').value, 10);
            const newCreatedTime = getCurrentTimestamp();
            const newModifiedTime = getCurrentTimestamp();
            const newCompleted = 2;
            console.log("Attempting to send question via html");
            fetch(`/api/add_question`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: newID,
                    question: newQuestion,
                    options: newOptions,
                    correctIndex: newCorrectIndex,
                    createdTime: newCreatedTime,
                    modifiedTime: newModifiedTime,
                    completed: newCompleted
                })
            }).then(response => response.json())
                .then(data => {
                    // 刷新页面或者其他操作
                });
        });
        
        function getCurrentTimestamp() {
            const now = new Date();
            return now.toISOString();
        }

    </script>

    <script>    //make cells editable
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('table tr td:not(:first-child):not(:nth-last-child(2)):not(:last-child)').forEach(cell => {
                cell.addEventListener('click', function () {
                    if (!this.querySelector('input')) {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = this.innerText;
                        this.innerHTML = '';
                        this.appendChild(input);
                        input.focus();

                        input.addEventListener('blur', function () {
                            const value = this.value;
                            this.parentElement.innerHTML = value;
                        });
                    }
                });
            });
        });


    </script>

    <script>    //Update database

        document.querySelectorAll('.updateQuestion').forEach(function (button) {
            button.addEventListener('click', function (e) {
                console.log('click is detected');
                // 获取这个按钮所在行的所有单元格
                const row = this.closest('tr');
                const cells = row.querySelectorAll('td');

                // 从这些单元格中提取数据
                const newID = parseInt(cells[0].innerText, 10);
                const newQuestion = cells[1].innerText;
                const newOptions = cells[2].innerText;
                const newCorrectIndex = parseInt(cells[3].innerText, 10);
                const newCreatedTime = cells[4].innerText;
                const newModifiedTime = getCurrentTimestamp();
                const newCompleted = 2;

                // send new question to server side
                fetch(`/api/update_question`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: newID,
                        question: newQuestion,
                        options: newOptions,
                        correctIndex: newCorrectIndex,
                        createdTime: newCreatedTime,
                        modifiedTime: newModifiedTime,
                        completed: newCompleted
                    })
                }).then(response => response.json())
                    .then(data => {
                        location.reload();
                    });
                console.log("Html 已经收到更新, 发送更新到服务器");

            });
        });
    </script>

</body>

</html>